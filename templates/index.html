<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockWatcher</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='dashboard.js') }}" defer></script>
</head>
<body>
    <div class="container">
        <h1>StockWatcher</h1>
        
        <div class="search-box">
            <input type="text" id="stockInput" placeholder="Enter stock symbol (e.g., AAPL)">
            <button onclick="dashboard.searchStock()">Get Price</button>
            <button onclick="dashboard.showHistory()" id="historyBtn" style="display:none">History</button>
            <button onclick="dashboard.addToWatchlist()" id="watchlistBtn" style="display:none">Add to Watchlist</button>
            <button onclick="dashboard.addToPortfolio()" id="portfolioBtn" style="display:none">Add to Portfolio</button>
        </div>
        
        <div id="result" class="result"></div>
        <div id="history" class="history" style="display:none;"></div>
        
        <div class="dashboard-grid">
            <div class="watchlist-section">
                <h2>Watchlist</h2>
                <div id="watchlist" class="watchlist"></div>
                <button onclick="dashboard.loadWatchlist()" class="refresh-btn">Refresh Watchlist</button>
            </div>
            
            <div class="portfolio-section">
                <h2>Portfolio</h2>
                <div id="portfolio" class="portfolio"></div>
                <button onclick="dashboard.loadPortfolio()" class="refresh-btn">Refresh Portfolio</button>
            </div>
        </div>
        
        <div class="tools-section">
            <h2>Stock Comparison Tool</h2>
            <div class="compare-box">
                <input type="text" id="compareInput" placeholder="Enter symbols separated by commas (e.g., AAPL,GOOGL,MSFT)">
                <button onclick="compareStocks()">Compare Stocks</button>
            </div>
            <div id="comparison" class="comparison" style="display:none;"></div>
        </div>
    </div>

    <script>
        function searchStock() {
            const symbol = document.getElementById('stockInput').value.toUpperCase();
            const resultDiv = document.getElementById('result');
            
            if (!symbol) {
                resultDiv.innerHTML = '<p class="error">Please enter a stock symbol</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Loading...</p>';
            
            fetch(`/api/stock/${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultDiv.innerHTML = `<p class="error">${data.error}</p>`;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="stock-info">
                                <h2>${data.symbol}</h2>
                                <p class="price">$${data.price.toFixed(2)}</p>
                                <p class="currency">${data.currency}</p>
                            </div>
                        `;
                        document.getElementById('historyBtn').style.display = 'inline-block';
                        document.getElementById('watchlistBtn').style.display = 'inline-block';
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = '<p class="error">Failed to fetch stock data</p>';
                });
        }
        
        function showHistory() {
            const symbol = document.getElementById('stockInput').value.toUpperCase();
            const historyDiv = document.getElementById('history');
            
            historyDiv.innerHTML = '<p>Loading history...</p>';
            historyDiv.style.display = 'block';
            
            fetch(`/api/history/${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        historyDiv.innerHTML = `<p class="error">${data.error}</p>`;
                    } else {
                        let historyHTML = `<h3>Price History for ${data.symbol}</h3><div class="history-list">`;
                        data.history.slice(0, 10).forEach(entry => {
                            const date = new Date(entry.timestamp).toLocaleString();
                            historyHTML += `<div class="history-item">
                                <span class="hist-price">$${entry.price.toFixed(2)}</span>
                                <span class="hist-time">${date}</span>
                            </div>`;
                        });
                        historyHTML += '</div>';
                        historyDiv.innerHTML = historyHTML;
                    }
                })
                .catch(error => {
                    historyDiv.innerHTML = '<p class="error">Failed to fetch history</p>';
                });
        }
        
        function addToWatchlist() {
            const symbol = document.getElementById('stockInput').value.toUpperCase();
            const targetPrice = prompt(`Enter target price for ${symbol} (optional):`);
            
            const payload = {
                symbol: symbol
            };
            
            if (targetPrice && !isNaN(parseFloat(targetPrice))) {
                payload.target_price = parseFloat(targetPrice);
            }
            
            fetch('/api/watchlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(data.message);
                    loadWatchlist();
                }
            })
            .catch(error => {
                alert('Failed to add to watchlist');
            });
        }
        
        function loadWatchlist() {
            fetch('/api/watchlist')
                .then(response => response.json())
                .then(data => {
                    const watchlistDiv = document.getElementById('watchlist');
                    if (data.length === 0) {
                        watchlistDiv.innerHTML = '<p class="empty-watchlist">No stocks in watchlist</p>';
                        return;
                    }
                    
                    let watchlistHTML = '';
                    data.forEach(item => {
                        watchlistHTML += `
                            <div class="watchlist-item">
                                <span class="symbol">${item.symbol}</span>
                                <span class="target-price">${item.target_price ? '$' + item.target_price.toFixed(2) : 'No target'}</span>
                                <span class="alert-status ${item.alert_enabled ? 'enabled' : 'disabled'}">
                                    ${item.alert_enabled ? 'Alert ON' : 'Alert OFF'}
                                </span>
                                <button onclick="removeFromWatchlist('${item.symbol}')" class="remove-btn">Remove</button>
                            </div>
                        `;
                    });
                    watchlistDiv.innerHTML = watchlistHTML;
                })
                .catch(error => {
                    document.getElementById('watchlist').innerHTML = '<p class="error">Failed to load watchlist</p>';
                });
        }
        
        function removeFromWatchlist(symbol) {
            if (!confirm(`Remove ${symbol} from watchlist?`)) return;
            
            fetch(`/api/watchlist/${symbol}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    loadWatchlist();
                }
            })
            .catch(error => {
                alert('Failed to remove from watchlist');
            });
        }
        
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });
        
        function compareStocks() {
            const input = document.getElementById('compareInput').value.trim();
            if (!input) {
                alert('Please enter stock symbols');
                return;
            }
            
            const comparisonDiv = document.getElementById('comparison');
            comparisonDiv.innerHTML = '<p class="loading">Loading comparison...</p>';
            comparisonDiv.style.display = 'block';
            
            fetch(`/api/compare?symbols=${encodeURIComponent(input)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        comparisonDiv.innerHTML = `<p class="error">${data.error}</p>`;
                    } else {
                        displayComparison(data, comparisonDiv);
                    }
                })
                .catch(error => {
                    console.error('Compare error:', error);
                    comparisonDiv.innerHTML = '<p class="error">Failed to compare stocks</p>';
                });
        }
        
        function displayComparison(data, container) {
            let comparisonHTML = '<h3>Stock Comparison</h3><div class="comparison-grid">';
            
            Object.entries(data).forEach(([symbol, stockData]) => {
                const changeIndicator = stockData.previous_close ? 
                    (stockData.price > stockData.previous_close ? '↗' : '↘') : '';
                const changeClass = stockData.previous_close ? 
                    (stockData.price > stockData.previous_close ? 'positive' : 'negative') : '';
                
                comparisonHTML += `
                    <div class="comparison-item">
                        <h4 onclick="dashboard.quickSearch('${symbol}')" class="clickable-symbol">${symbol}</h4>
                        <p class="comparison-price ${changeClass}">$${stockData.price.toFixed(2)} ${changeIndicator}</p>
                        <p class="comparison-market">${stockData.market_state}</p>
                        ${stockData.previous_close ? `<p class="comparison-change">Prev: $${stockData.previous_close.toFixed(2)}</p>` : ''}
                    </div>
                `;
            });
            
            comparisonHTML += '</div>';
            container.innerHTML = comparisonHTML;
        }
        
        document.getElementById('compareInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                compareStocks();
            }
        });
    </script>
</body>
</html>